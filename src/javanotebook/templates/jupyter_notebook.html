<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Java Notebook - {{ notebook_filename }}</title>
    <link rel="stylesheet" href="/static/css/jupyter_notebook.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/default.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">

    <!-- Jupyter-specific libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/clike/clike.min.js"></script>
</head>
<body>
    <header class="jupyter-header">
        <div class="container">
            <h1>üìì Java Notebook (Jupyter)</h1>
            <div class="notebook-info">
                <span class="filename">{{ notebook_filename }}</span>
                <div class="notebook-meta">
                    <span class="format-badge">{{ format }}</span>
                    <span class="version-badge">v{{ nbformat_version }}</span>
                </div>
                <div class="stats">
                    <span class="stat">Ï¥ù {{ total_cells }}Í∞ú ÏÖÄ</span>
                    <span class="stat">ÏΩîÎìú {{ code_cells }}Í∞ú</span>
                    <span class="stat">ÎßàÌÅ¨Îã§Ïö¥ {{ markdown_cells }}Í∞ú</span>
                    {% if raw_cells > 0 %}
                    <span class="stat">Raw {{ raw_cells }}Í∞ú</span>
                    {% endif %}
                    <button class="btn btn-add-cell" onclick="addNewCodeCell()">+ ÏΩîÎìú ÏÖÄ Ï∂îÍ∞Ä</button>
                    <button class="btn btn-add-markdown" onclick="addNewMarkdownCell()">+ ÎßàÌÅ¨Îã§Ïö¥ ÏÖÄ Ï∂îÍ∞Ä</button>
                </div>
            </div>
        </div>
    </header>

    <main class="jupyter-main">
        <div class="container">
            <div class="jupyter-toolbar">
                <div class="toolbar-group">
                    <button class="btn btn-run-all" onclick="runAllCells()">‚ñ∂ Î™®Îì† ÏÖÄ Ïã§Ìñâ</button>
                    <button class="btn btn-restart" onclick="restartKernel()">üîÑ Ïª§ÎÑê Ïû¨ÏãúÏûë</button>
                </div>
                <div class="toolbar-group">
                    <button class="btn btn-save" onclick="saveNotebook()">üíæ Ï†ÄÏû•</button>
                    <button class="btn btn-export" onclick="exportNotebook()">üì§ ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>
                </div>
            </div>

            <div class="jupyter-notebook">
                <!-- AIDEV-NOTE: Debug info for cell rendering -->
                <!-- Total cells: {{ notebook.cells|length }} -->
                {% for cell in notebook.cells %}
                <div class="jupyter-cell {{ cell.cell_type }}-cell" data-cell-id="{{ cell.id }}" data-cell-type="{{ cell.cell_type }}" data-cell-index="{{ loop.index0 }}">

                    <!-- Debug: Cell {{ loop.index }}/{{ notebook.cells|length }} - ID: {{ cell.id }} - Type: {{ cell.cell_type }} -->

                    {% if cell.cell_type == "markdown" %}
                    <!-- Markdown Cell -->
                    <div class="cell-toolbar">
                        <span class="cell-type-indicator">Markdown</span>
                        <div class="cell-actions">
                            <button class="btn btn-edit" onclick="editMarkdownCell('{{ cell.id }}')">Ìé∏Ïßë</button>
                            <button class="btn btn-delete" onclick="deleteCell('{{ cell.id }}')">ÏÇ≠Ï†ú</button>
                        </div>
                    </div>

                    <div class="markdown-cell-content" id="markdown-content-{{ cell.id }}">
                        <!-- Rendered markdown will be inserted here by JavaScript -->
                    </div>

                    <div class="markdown-cell-editor" id="markdown-editor-{{ cell.id }}" style="display: none;">
                        <textarea class="markdown-source" id="markdown-source-{{ cell.id }}">{% if cell.source is string %}{{ cell.source }}{% else %}{{ cell.source | join }}{% endif %}</textarea>
                        <div class="editor-actions">
                            <button class="btn btn-render" onclick="renderMarkdownCell('{{ cell.id }}')">Î†åÎçîÎßÅ</button>
                            <button class="btn btn-cancel" onclick="cancelMarkdownEdit('{{ cell.id }}')">Ï∑®ÏÜå</button>
                        </div>
                    </div>

                    {% elif cell.cell_type == "code" %}
                    <!-- Code Cell -->
                    <div class="code-cell-input-section">
                        <div class="code-cell-prompt">
                            <div class="input-prompt">
                                In [{% if cell.execution_count %}{{ cell.execution_count }}{% else %}&nbsp;{% endif %}]:
                            </div>
                        </div>

                        <div class="code-cell-content">
                            <div class="cell-toolbar">
                                <span class="cell-type-indicator">‚òï Java</span>
                                <div class="cell-actions">
                                    <button class="btn btn-run" onclick="executeJupyterCell('{{ cell.id }}')">
                                        <span class="btn-text">Ïã§Ìñâ</span>
                                        <span class="btn-spinner" style="display: none;">‚ö°</span>
                                    </button>
                                    <button class="btn btn-validate" onclick="validateJupyterCell('{{ cell.id }}')">Í≤ÄÏ¶ù</button>
                                    <button class="btn btn-delete" onclick="deleteCell('{{ cell.id }}')">ÏÇ≠Ï†ú</button>
                                    <button class="cell-connection-btn btn btn-sm" id="connect-btn-{{ cell.id }}" onclick="handleConnectionClick('{{ cell.id }}')" title="Îã§Î•∏ ÏÖÄÍ≥º Ïó∞Í≤∞">üîó</button>
                                </div>
                            </div>

                            <div class="code-input">
                                <textarea class="code-editor" id="editor-{{ cell.id }}">{% if cell.source is string %}{{ cell.source }}{% else %}{{ cell.source | join }}{% endif %}</textarea>
                            </div>
                        </div>
                    </div>

                    <div class="code-cell-output" id="output-{{ cell.id }}" style="display: none;">
                        <div class="output-prompt">
                            Out[<span id="output-number-{{ cell.id }}">&nbsp;</span>]:
                        </div>
                        <div class="output-content" id="output-content-{{ cell.id }}">
                            <!-- Execution results will be inserted here -->
                        </div>
                    </div>

                    {% elif cell.cell_type == "raw" %}
                    <!-- Raw Cell -->
                    <div class="cell-toolbar">
                        <span class="cell-type-indicator">Raw</span>
                        <div class="cell-actions">
                            <button class="btn btn-edit" onclick="editRawCell('{{ cell.id }}')">Ìé∏Ïßë</button>
                            <button class="btn btn-delete" onclick="deleteCell('{{ cell.id }}')">ÏÇ≠Ï†ú</button>
                        </div>
                    </div>

                    <div class="raw-cell-content" id="raw-content-{{ cell.id }}">
                        <pre class="raw-display">{% if cell.source is string %}{{ cell.source }}{% else %}{{ cell.source | join }}{% endif %}</pre>
                    </div>

                    <div class="raw-cell-editor" id="raw-editor-{{ cell.id }}" style="display: none;">
                        <textarea class="raw-source" id="raw-source-{{ cell.id }}" placeholder="Raw cell content...">{% if cell.source is string %}{{ cell.source }}{% else %}{{ cell.source | join }}{% endif %}</textarea>
                        <div class="editor-actions">
                            <button class="btn btn-save-raw" onclick="saveRawCell('{{ cell.id }}')">Ï†ÄÏû•</button>
                            <button class="btn btn-cancel" onclick="cancelRawEdit('{{ cell.id }}')">Ï∑®ÏÜå</button>
                        </div>
                    </div>

                    {% endif %}

                </div>
                {% endfor %}
            </div>
        </div>
    </main>

    <footer class="jupyter-footer">
        <div class="container">
            <div class="footer-content">
                <p>Java Notebook v0.2.0 - Jupyter Ìò∏Ìôò Java Ïã§Ìñâ ÌôòÍ≤Ω</p>
                <div class="kernel-status">
                    <span class="status-indicator" id="kernel-status">üü¢</span>
                    <span class="status-text">Java Ïª§ÎÑê Ï§ÄÎπÑÎê®</span>
                </div>
            </div>
        </div>
    </footer>

    <!-- Modal for adding cells -->
    <div id="add-cell-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ÏÉà ÏÖÄ Ï∂îÍ∞Ä</h3>
                <button class="modal-close" onclick="closeAddCellModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="cell-type-selector">
                    <button class="btn btn-cell-type" data-type="code">‚òï ÏΩîÎìú ÏÖÄ</button>
                    <button class="btn btn-cell-type" data-type="markdown">üìù ÎßàÌÅ¨Îã§Ïö¥ ÏÖÄ</button>
                    <button class="btn btn-cell-type" data-type="raw">üìÑ Raw ÏÖÄ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables for Jupyter notebook
        window.notebookFormat = 'ipynb';
        window.notebookData = {
            filename: '{{ notebook_filename }}',
            format: '{{ format }}',
            version: '{{ nbformat_version }}',
            totalCells: {{ total_cells }},
            codeCells: {{ code_cells }},
            markdownCells: {{ markdown_cells }},
            rawCells: {{ raw_cells }}
        };

        // Cell data for JavaScript
        window.cellData = {{ cell_data_json | safe }};

        // Notebook path for connection functionality
        window.notebookPath = {{ notebook_path | tojson }};

        // AIDEV-NOTE: Debug information
        console.log('Notebook loaded with', window.cellData.length, 'cells');
        console.log('Cell IDs:', window.cellData.map(c => c.id));
        console.log('Cell types:', window.cellData.map(c => c.type));
    </script>

    <script src="/static/js/jupyter_notebook.js"></script>
    <script>
        // Initialize Jupyter notebook interface
        document.addEventListener('DOMContentLoaded', function() {
            initializeJupyterNotebook();
        });
    </script>
</body>
</html>